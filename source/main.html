<!doctype html>
<html lang="fa">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weekly Timeline (stacked lanes, minute-precise)</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --timeline-start: 8;
      /* ساعت شروع (مثال: 8 = 08:00) */
      --timeline-end: 18;
      /* ساعت پایان */
      --lane-height: 48px;
      /* ارتفاع هر لِین (هر ردیف کلاس) */
      --lane-gap: 6px;
      /* فاصله بین لِین‌ها */
    }

    body {
      font-family: "Tahoma", Arial, sans-serif;
      background: #f7f7f9;
      padding: 20px;
    }

    .container-tl {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* خط زمان بالایی */
    .time-scale {
      display: flex;
      gap: 0;
      margin-bottom: 8px;
      background: transparent;
      user-select: none;
    }

    .time-scale .tick {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: #333;
      border-left: 1px solid rgba(0, 0, 0, 0.06);
      padding: 6px 0;
      background: #fff;
    }

    .time-scale .tick:first-child {
      border-left: none;
    }

    /* ردیف روز */
    .day-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: flex-start;
    }

    .day-label {
      width: 72px;
      min-width: 72px;
      text-align: right;
      padding-right: 8px;
      font-weight: 600;
      font-size: 14px;
      color: #222;
    }

    .day-timeline {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.06);
      position: relative;
      width: 100%;
      overflow: visible;
      /* لازم برای لِین‌ها */
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.02) inset;
    }

    /* خط چین دقیقه‌ای (هر 30 دقیقه) — بصری */
    .day-timeline .gridline {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 1px;
      background: rgba(0, 0, 0, 0.03);
      pointer-events: none;
    }

    .course-block {
      position: absolute;
      height: var(--lane-height);
      border-radius: 6px;
      color: #fff;
      padding: 6px 8px;
      font-size: 13px;
      line-height: calc(var(--lane-height) - 0px);
      box-sizing: border-box;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
      cursor: default;
    }

    /* چند رنگ نمونه — رنگ‌ها با هش courseId ست میشه */
    .color-0 {
      background: #4CAF50;
    }

    .color-1 {
      background: #2196F3;
    }

    .color-2 {
      background: #FF9800;
    }

    .color-3 {
      background: #9C27B0;
    }

    .color-4 {
      background: #F44336;
    }

    .color-5 {
      background: #3F51B5;
    }

    .color-6 {
      background: #00BCD4;
    }

    .color-7 {
      background: #8BC34A;
    }

    /* وقتی متن خیلی کم جا داره، اندازه فونت رو کمتر کن */
    .course-block.small {
      font-size: 11px;
      padding: 4px 6px;
    }

    /* مرزبندی و نکات ریسپانسیو */
    @media (max-width:600px) {
      .day-label {
        width: 58px;
        min-width: 58px;
        font-size: 13px;
      }

      :root {
        --lane-height: 42px;
      }
    }
  </style>
</head>

<body>

  <div class="container-tl">
    <h4 class="mb-2">برنامه هفتگی — Timeline دقیقه‌ای (بدون هم‌پوشانی)</h4>
    <p class="text-muted small mb-3">هر کلاس در لِین جدا قرار می‌گیرد تا هم‌تداخل‌ها پوشیده نشوند. نشانگر ماوس را روی
      بلوک نگه دارید تا جزئیات را ببینید.</p>

    <!-- خط زمان -->
    <div id="timeScale" class="time-scale mb-2"></div>

    <!-- جدول روزها -->
    <div id="timelineContainer"></div>
  </div>

  <!-- Bootstrap JS (برای tooltip) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ==== داده‌ی ورودی (همان JSONی که فرستادی) ==== */
    const data = {
      "schedule": [
        {
          "courseId": "C1",
          "roomId": "R2",
          "sessions": [
            {
              "courseId": "C1",
              "roomId": "R2",
              "day": "Sat",
              "start": "08:00",
              "end": "09:15"
            },
            {
              "courseId": "C1",
              "roomId": "R2",
              "day": "Mon",
              "start": "08:00",
              "end": "09:15"
            }
          ]
        },
        {
          "courseId": "C2",
          "roomId": "R2",
          "sessions": [
            {
              "courseId": "C2",
              "roomId": "R2",
              "day": "Sun",
              "start": "08:00",
              "end": "08:15"
            }
          ]
        },
        {
          "courseId": "C3",
          "roomId": "R1",
          "sessions": [
            {
              "courseId": "C3",
              "roomId": "R1",
              "day": "Sat",
              "start": "09:30",
              "end": "10:30"
            },
            {
              "courseId": "C3",
              "roomId": "R1",
              "day": "Tue",
              "start": "09:30",
              "end": "10:30"
            }
          ]
        },
        {
          "courseId": "C4",
          "roomId": "R1",
          "sessions": [
            {
              "courseId": "C4",
              "roomId": "R1",
              "day": "Sat",
              "start": "10:45",
              "end": "12:00"
            }
          ]
        },
        {
          "courseId": "C5",
          "roomId": "R2",
          "sessions": [
            {
              "courseId": "C5",
              "roomId": "R2",
              "day": "Sun",
              "start": "10:45",
              "end": "12:30"
            },
            {
              "courseId": "C5",
              "roomId": "R2",
              "day": "Tue",
              "start": "10:45",
              "end": "12:30"
            }
          ]
        },
        {
          "courseId": "C6",
          "roomId": "R3",
          "sessions": [
            {
              "courseId": "C6",
              "roomId": "R3",
              "day": "Sat",
              "start": "12:15",
              "end": "13:45"
            }
          ]
        }
      ]
    }

    /* تنظیمات timeline */
    const DAYS = ["Sat", "Sun", "Mon", "Tue", "Wed", "Thu", "Fri"];
    const TL_START = 8;   // ساعت شروع (مثال: 8 -> 08:00)
    const TL_END = 18;    // ساعت پایان
    const TOTAL_MINUTES = (TL_END - TL_START) * 60;

    /* palette index از courseId (ثابت، اما ساده) */
    function colorIndexFromId(id) {
      // ساده: مجموع کدهای حروف -> مدول طول پالت
      let s = 0;
      for (let i = 0; i < id.length; i++) s += id.charCodeAt(i);
      return s % 8; // 8 رنگ (color-0..color-7)
    }

    /* تبدیل "HH:MM" به دقیقه از شروع timeline */
    function minutesFromStart(timeStr) {
      const [hh, mm] = timeStr.split(':').map(x => parseInt(x, 10));
      return (hh - TL_START) * 60 + mm;
    }

    /* ساخت خط زمان (tick هر ساعت) */
    function renderTimeScale() {
      const scale = document.getElementById('timeScale');
      scale.innerHTML = '';
      const totalTicks = TL_END - TL_START;
      for (let i = 0; i <= totalTicks; i++) {
        const tick = document.createElement('div');
        tick.className = 'tick';
        let hour = TL_START + i;
        tick.textContent = (hour < 10 ? '0' + hour : hour) + ":00";
        scale.appendChild(tick);
      }
    }

    /* برای هر روز، جلسات را جمع می‌کنیم و لِین اختصاص می‌دهیم */
    function buildDayRows() {
      const container = document.getElementById('timelineContainer');
      container.innerHTML = '';

      // تبدیل داده به لیست جلسات تخت: [{courseId,roomId,day,start,end}]
      const flatSessions = [];
      data.schedule.forEach(course => {
        course.sessions.forEach(s => {
          flatSessions.push({
            courseId: course.courseId,
            roomId: course.roomId,
            day: s.day,
            start: s.start,
            end: s.end
          });
        });
      });

      // گروه‌بندی بر اساس روز
      const sessionsByDay = {};
      DAYS.forEach(d => sessionsByDay[d] = []);
      flatSessions.forEach(s => {
        if (sessionsByDay[s.day]) sessionsByDay[s.day].push(s);
        // اگر روز نامعتبر باشد، نادیده گرفته می‌شود
      });

      // برای هر روز:
      DAYS.forEach(day => {
        // ردیف روز
        const row = document.createElement('div');
        row.className = 'day-row';

        const label = document.createElement('div');
        label.className = 'day-label';
        label.textContent = day;
        row.appendChild(label);

        const timeline = document.createElement('div');
        timeline.className = 'day-timeline';
        timeline.style.minHeight = 'calc(var(--lane-height) + var(--lane-gap))';
        timeline.style.position = 'relative';
        row.appendChild(timeline);

        // اگر در این روز هیچ سشن نیست، فقط یک خط خالی نمایش بده
        const sessions = sessionsByDay[day] || [];
        if (sessions.length === 0) {
          // عرض یک gridline در شروع (اختیاری)
          container.appendChild(row);
          return;
        }

        // مرتب‌سازی بر اساس شروع
        sessions.sort((a, b) => {
          const ma = minutesFromStart(a.start);
          const mb = minutesFromStart(b.start);
          return ma - mb;
        });

        // الگوریتم اختصاص لِین (greedy): برای هر سشن، دنبال اولین لِینی بگرد که با آخرین پایان آن لِین تداخل نداشته باشه
        const lanes = []; // هر آیتم: {lastEndMinutes: number}
        const placed = []; // برای ذخیره نتایج

        sessions.forEach(s => {
          const sStart = minutesFromStart(s.start);
          const sEnd = minutesFromStart(s.end);
          // اگر session خارج از بازه timeline است، آن را در محدوده clamp می‌کنیم
          const clampedStart = Math.max(0, sStart);
          const clampedEnd = Math.min(TOTAL_MINUTES, sEnd);

          let laneIndex = -1;
          for (let i = 0; i < lanes.length; i++) {
            if (lanes[i].lastEnd <= clampedStart) {
              laneIndex = i;
              break;
            }
          }
          if (laneIndex === -1) {
            // لِین جدید
            laneIndex = lanes.length;
            lanes.push({ lastEnd: clampedEnd });
          } else {
            lanes[laneIndex].lastEnd = clampedEnd;
          }

          placed.push({
            ...s,
            startMin: clampedStart,
            endMin: clampedEnd,
            lane: laneIndex
          });
        });

        // set timeline height بر اساس تعداد لِین
        const laneHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--lane-height')) || 48;
        const laneGap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--lane-gap')) || 6;
        const totalHeight = lanes.length * laneHeight + (lanes.length - 1) * laneGap + 8;
        timeline.style.height = totalHeight + 'px';

        // رسم خطوط عمودی (یک خط هر 30 دقیقه یا هر ساعت برای کمک بصری)
        // در این نسخه خطوط ساعت به صورت هر 30 دقیقه رسم می‌شوند (می‌توان عوض کرد)
        const tickIntervalMinutes = 30;
        const ticksCount = Math.ceil(TOTAL_MINUTES / tickIntervalMinutes);
        for (let t = 0; t <= ticksCount; t++) {
          const mm = t * tickIntervalMinutes;
          const leftPct = (mm / TOTAL_MINUTES) * 100;
          const gl = document.createElement('div');
          gl.className = 'gridline';
          gl.style.left = leftPct + '%';
          gl.style.opacity = (mm % 60 === 0) ? '0.25' : '0.08'; // خطوط ساعت پررنگ‌تر
          timeline.appendChild(gl);
        }

        // افزودن بلوک‌ها
        placed.forEach(p => {
          if (p.endMin <= p.startMin) return; // نادیده گرفتن موارد نامعتبر

          const leftPct = (p.startMin / TOTAL_MINUTES) * 100;
          const widthPct = ((p.endMin - p.startMin) / TOTAL_MINUTES) * 100;

          const block = document.createElement('div');
          block.className = 'course-block color-' + colorIndexFromId(p.courseId);
          // اگر خیلی پهنا کم باشه، کلاس small بزن تا فونت کوچیکتر شه
          if (widthPct < 6) block.classList.add('small');

          block.style.left = leftPct + '%';
          block.style.width = widthPct + '%';
          // بالا (top) بسته به لِین
          const top = p.lane * (laneHeight + laneGap) + 5; // پدینگ از بالا
          block.style.top = top + 'px';

          // متن داخل بلوک (عنوان + اتاق)
          block.textContent = p.courseId + ' · ' + p.roomId;

          // tooltip با جزئیات
          block.setAttribute('data-bs-toggle', 'tooltip');
          block.setAttribute('data-bs-placement', 'top');
          block.title = `${p.courseId} — ${p.roomId}\n${p.start} - ${p.end}`;

          timeline.appendChild(block);
        });

        container.appendChild(row);
      });

      // init bootstrap tooltips
      const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (el) {
        return new bootstrap.Tooltip(el, { html: false });
      });
    }

    /* اجرا */
    renderTimeScale();
    buildDayRows();

    /* اگر نیاز به رفرش دستی داشتی، می‌تونی این توابع رو صدا بزنی یا data را تغییر بدی و buildDayRows() را بزنید. */

  </script>
</body>

</html>